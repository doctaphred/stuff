#!/usr/bin/env bash
set -euo pipefail

key="$1"

log () {
    >&2 echo "$@"
}

if ! test -e "data/$key"; then
    log "Data not found"
    if test -e "urls/$key"; then
        # The data doesn't exist, but a URLs file does.
        n="$(wc -l < "urls/$key" | tr -d ' ')"
        log "Attempting to download from $n URL(s)"
        tmp="$(mktemp -t stuff)"
        while read url; do
            log "Downloading from $url"
            curl "$url" > "$tmp" || continue
            log "Validating download"
            shasum -a256 --check <<< "$key  $tmp" > /dev/null || continue
            log "Successfully downloaded $key"
            mv "$tmp" "data/$key"
            break
        done < "urls/$key"
        if ! test -e "data/$key"; then
            log "ERROR: could not download $key"
            exit 1
        fi
    else
        log "ERROR: no data or URLs defined for $key"
        exit 1
    fi
fi

shasum -a256 --check <<< "$key  data/$key" > /dev/null
cat "data/$key"
